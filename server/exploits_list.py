from flask import Blueprint, request, send_file
import subprocess
import os

exploits_list_routes = Blueprint("exploits_list", __name__)


@exploits_list_routes.route("/make-exploits-list", methods=["POST"])
def make_exploits_list():
    if "file" not in request.files:
        return "No file uploaded", 400

        file = request.files["file"]
    if file.filename == "":
        return "No file selected", 400

    filename = "ExploitsList"
    file_path = os.path.join(os.path.dirname(__file__), "uploads", filename + ".pdf")
    file.save(file_path)

    output_file_cve = os.path.join(
        os.path.dirname(__file__), "output", "exploits_list", "CveList.txt"
    )
    output_file_exploits_temp = os.path.join(
        os.path.dirname(__file__), "output", "exploits_list", "ExploitsListTemp.txt"
    )
    output_file_exploits = os.path.join(
        os.path.dirname(__file__), "output", "exploits_list", "ExploitsList.txt"
    )

    if "option" in request.form and request.form["option"] == "2":
        extract_cve_command = f"pdfgrep '[0-9]{{4}}-[0-9]{{4,7}}' '{file_path}' | sed -r 's/^.*([0-9]{{4}}-[0-9]{{4,7}}).*$/\\1/g' | sort | uniq > '{output_file_cve}'"
        subprocess.run(extract_cve_command, shell=True)

        cve_list = []
        with open(output_file_cve, "r") as cve_file:
            cve_list = cve_file.read().splitlines()

        for cve in cve_list:
            search_exploit_command = (
                f"searchsploit --cve {cve} -w -v >> '{output_file_exploits}'"
            )
            subprocess.run(search_exploit_command, shell=True)

        remove_no_results_command = (
            f"sed -i '/Exploits: No Results/{{N;N;N;d;}}' '{output_file_exploits}'"
        )
        subprocess.run(remove_no_results_command, shell=True)

    else:
        extract_cve_command = f"pdfgrep 'CVE-[0-9]{{4}}-[0-9]{{4,7}}' '{file_path}' | sed -r 's/^.*(CVE-[0-9]{{4}}-[0-9]{{4,7}}).*$/\\1/g' | sort | uniq > '{output_file_cve}'"
        subprocess.run(extract_cve_command, shell=True)
        cve_search_exploit_command = (
            f"cve_searchsploit -f '{output_file_cve}' > '{output_file_exploits_temp}'"
        )
        subprocess.run(cve_search_exploit_command, shell=True)

        extract_exploits_command = f"grep 'Exploit DB Id:' '{output_file_exploits_temp}' -B 4 -A 6 > '{output_file_exploits}'"
        subprocess.run(extract_exploits_command, shell=True)

    download_link = request.host_url + f"download/{filename}"
    return {"downloadLink": download_link}
