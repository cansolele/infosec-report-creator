from flask import Blueprint, request, send_file
import subprocess
import os

exploits_list_routes = Blueprint("exploits_list", __name__)

@exploits_list_routes.route("/make-exploits-list", methods=["POST"])
def make_exploits_list():
    if "file" not in request.files:
        return "No file uploaded", 400

    file = request.files["file"]
    if file.filename == "":
        return "No file selected", 400

    filename = "ExploitsList"
    file_path = os.path.join(os.path.dirname(__file__), "uploads", filename + ".pdf")
    file.save(file_path)

    output_file_cve = os.path.join(
        os.path.dirname(__file__), "output", "exploits_list", "CveList.txt"
    )

    command1 = f"pdfgrep 'CVE-[0-9]{{4}}-[0-9]{{4,7}}' '{file_path}' | sed -r 's/^.*(CVE-[0-9]{{4}}-[0-9]{{4,7}}).*$/\\1/g' | sort | uniq > '{output_file_cve}'"
    subprocess.run(command1, shell=True)

    output_file_exploits_temp = os.path.join(
        os.path.dirname(__file__), "output", "exploits_list", "ExploitsListTemp.txt"
    )

    command2 = (
        f"cve_searchsploit -f '{output_file_cve}' > '{output_file_exploits_temp}'"
    )
    subprocess.run(command2, shell=True)

    output_file_exploits = os.path.join(
        os.path.dirname(__file__), "output", "exploits_list", "ExploitsList.txt"
    )

    command3 = f"grep 'Exploit DB Id:' '{output_file_exploits_temp}' -B 4 -A 6 > '{output_file_exploits}'"
    subprocess.run(command3, shell=True)

    download_link = request.host_url + f"download/{filename}"
    return {"downloadLink": download_link}
